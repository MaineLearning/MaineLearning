var wpLink;
(function(e){var c={},g,h,m,i,j,k;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",init:function(){c.dialog=e("#wp-link");c.submit=e("#wp-link-submit");c.url=e("#url-field");c.nonce=e("#_ajax_linking_nonce");c.title=e("#link-title-field");c.openInNewTab=e("#link-target-checkbox");c.search=e("#search-field");g=new j(e("#search-results"));h=new j(e("#most-recent-results"));m=e(".query-results",c.dialog);c.dialog.keydown(wpLink.keydown);c.dialog.keyup(wpLink.keyup);
c.submit.click(function(a){a.preventDefault();wpLink.update()});e("#wp-link-cancel").click(function(a){a.preventDefault();wpLink.close()});e("#internal-toggle").click(wpLink.toggleInternalLinking);m.bind("river-select",wpLink.updateFields);c.search.keyup(wpLink.searchInternalLinks);c.dialog.bind("wpdialogrefresh",wpLink.refresh);c.dialog.bind("wpdialogbeforeopen",wpLink.beforeOpen);c.dialog.bind("wpdialogclose",wpLink.onClose)},beforeOpen:function(){wpLink.range=null;!wpLink.isMCE()&&document.selection&&
(wpLink.textarea.focus(),wpLink.range=document.selection.createRange())},open:function(){wpActiveEditor&&(this.textarea=e("#"+wpActiveEditor).get(0),c.dialog.data("wpdialog")||c.dialog.wpdialog({title:wpLinkL10n.title,width:480,height:"auto",modal:!0,dialogClass:"wp-dialog",zIndex:3E5}),c.dialog.wpdialog("open"))},isMCE:function(){return tinyMCEPopup&&(i=tinyMCEPopup.editor)&&!i.isHidden()},refresh:function(){g.refresh();h.refresh();wpLink.isMCE()?wpLink.mceRefresh():wpLink.setDefaultValues();c.url.focus()[0].select();
h.ul.children().length||h.ajax()},mceRefresh:function(){var a;i=tinyMCEPopup.editor;tinyMCEPopup.restoreSelection();(a=i.dom.getParent(i.selection.getNode(),"A"))?(c.url.val(i.dom.getAttrib(a,"href")),c.title.val(i.dom.getAttrib(a,"title")),"_blank"==i.dom.getAttrib(a,"target")&&c.openInNewTab.prop("checked",!0),c.submit.val(wpLinkL10n.update)):wpLink.setDefaultValues();tinyMCEPopup.storeSelection()},close:function(){wpLink.isMCE()?tinyMCEPopup.close():c.dialog.wpdialog("close")},onClose:function(){wpLink.isMCE()||
(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select()))},getAttrs:function(){return{href:c.url.val(),title:c.title.val(),target:c.openInNewTab.prop("checked")?"_blank":""}},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var a,d,b,c,f=wpLink.textarea;f&&(a=wpLink.getAttrs(),a.href&&"http://"!=a.href&&(d='<a href="'+a.href+'"',a.target&&(d+=' target="'+a.target+'"'),d+=">",a.title&&(d+=a.title),
document.selection&&wpLink.range?(f.focus(),wpLink.range.text=d+wpLink.range.text+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):"undefined"!==typeof f.selectionStart&&(a=f.selectionStart,b=f.selectionEnd,selection=f.value.substring(a,b),d=d+selection+"</a>",c=a+d.length,a==b&&(c-=4),f.value=f.value.substring(0,a)+d+f.value.substring(b,f.value.length),f.selectionStart=f.selectionEnd=c),wpLink.close(),f.focus()))},mceUpdate:function(){var a=
tinyMCEPopup.editor,d=wpLink.getAttrs(),b,c;tinyMCEPopup.restoreSelection();b=a.dom.getParent(a.selection.getNode(),"A");if(!d.href||"http://"==d.href)b&&(tinyMCEPopup.execCommand("mceBeginUndoLevel"),c=a.selection.getBookmark(),a.dom.remove(b,1),a.selection.moveToBookmark(c),tinyMCEPopup.execCommand("mceEndUndoLevel"),wpLink.close());else{tinyMCEPopup.execCommand("mceBeginUndoLevel");null==b?(a.getDoc().execCommand("unlink",!1,null),tinyMCEPopup.execCommand("mceInsertLink",!1,"#mce_temp_url#",{skip_undo:1}),
tinymce.each(a.dom.select("a"),function(c){"#mce_temp_url#"==a.dom.getAttrib(c,"href")&&(b=c,a.dom.setAttribs(b,d))}),"#mce_temp_url#"==e(b).text()&&(a.dom.remove(b),b=null)):a.dom.setAttribs(b,d);if(b&&(1!=b.childNodes.length||"IMG"!=b.firstChild.nodeName))a.focus(),a.selection.select(b),a.selection.collapse(0),tinyMCEPopup.storeSelection();tinyMCEPopup.execCommand("mceEndUndoLevel");wpLink.close()}},updateFields:function(a,d,b){c.url.val(d.children(".item-permalink").val());c.title.val(d.hasClass("no-title")?
"":d.children(".item-title").text());b&&"click"==b.type&&c.url.focus()},setDefaultValues:function(){c.url.val("http://");c.title.val("");c.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var a=e(this),d,b=a.val();2<b.length?(h.hide(),g.show(),wpLink.lastSearch!=b&&(wpLink.lastSearch=b,d=a.parent().find(".spinner").show(),g.change(b),g.ajax(function(){d.hide()}))):(g.hide(),h.show())},next:function(){g.next();h.next()},prev:function(){g.prev();h.prev()},keydown:function(a){var d,b=e.ui.keyCode;
switch(a.which){case b.UP:d="prev";case b.DOWN:d=d||"next";clearInterval(wpLink.keyInterval);wpLink[d]();wpLink.keyInterval=setInterval(wpLink[d],wpLink.keySensitivity);break;default:return}a.preventDefault()},keyup:function(a){var d=e.ui.keyCode;switch(a.which){case d.ESCAPE:return a.stopImmediatePropagation(),e(document).triggerHandler("wp_CloseOnEscape",[{event:a,what:"wplink",cb:wpLink.close}])||wpLink.close(),!1;case d.UP:case d.DOWN:clearInterval(wpLink.keyInterval);break;default:return}a.preventDefault()},
delayedCallback:function(a,d){var b,c,f,e;if(!d)return a;setTimeout(function(){if(c)return a.apply(e,f);b=!0},d);return function(){if(b)return a.apply(this,arguments);f=arguments;e=this;c=!0}},toggleInternalLinking:function(a){var d=e("#search-panel"),b=c.dialog.wpdialog("widget"),l=!d.is(":visible"),f=e(window);e(this).toggleClass("toggle-arrow-active",l);c.dialog.height("auto");d.slideToggle(300,function(){setUserSetting("wplink",l?"1":"0");c[l?"search":"url"].focus();var a=f.scrollTop(),d=b.offset().top,
e=d+b.outerHeight()-f.height();e>a&&b.animate({top:e<d?d-e:a},200)});a.preventDefault()}};j=function(a,d){var b=this;this.element=a;this.ul=a.children("ul");this.waiting=a.find(".river-waiting");this.change(d);this.refresh();a.scroll(function(){b.maybeLoad()});a.delegate("li","click",function(a){b.select(e(this),a)})};e.extend(j.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},
hide:function(){this.element.hide();this.visible=!1},select:function(a,d){var b,c,e,g;a.hasClass("unselectable")||a==this.selected||(this.deselect(),this.selected=a.addClass("selected"),b=a.outerHeight(),c=this.element.height(),e=a.position().top,g=this.element.scrollTop(),0>e?this.element.scrollTop(g+e):e+b>c&&this.element.scrollTop(g+e-c+b),this.element.trigger("river-select",[a,d,this]))},deselect:function(){this.selected&&this.selected.removeClass("selected");this.selected=!1},prev:function(){if(this.visible){var a;
this.selected&&(a=this.selected.prev("li"),a.length&&this.select(a))}},next:function(){if(this.visible){var a=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);a.length&&this.select(a)}},ajax:function(a){var d=this,b=wpLink.delayedCallback(function(b,c){d.process(b,c);a&&a(b,c)},1==this.query.page?0:wpLink.minRiverAJAXDuration);this.query.ajax(b)},change:function(a){this.query&&this._search==a||(this._search=a,this.query=new k(a),this.element.scrollTop(0))},process:function(a,
d){var b="",c=!0,f="",g=1==d.page;a?e.each(a,function(){f=c?"alternate":"";f+=this.title?"":" no-title";b+=f?'<li class="'+f+'">':"<li>";b+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';b+='<span class="item-title">';b+=this.title?this.title:wpLinkL10n.noTitle;b+='</span><span class="item-info">'+this.info+"</span></li>";c=!c}):g&&(b+='<li class="unselectable"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>");this.ul[g?"html":"append"](b)},
maybeLoad:function(){var a=this,c=this.element,b=c.scrollTop()+c.height();this.query.ready()&&!(b<this.ul.height()-wpLink.riverBottomThreshold)&&setTimeout(function(){var b=c.scrollTop(),e=b+c.height();a.query.ready()&&!(e<a.ul.height()-wpLink.riverBottomThreshold)&&(a.waiting.show(),c.scrollTop(b+a.waiting.outerHeight()),a.ajax(function(){a.waiting.hide()}))},wpLink.timeToTriggerRiver)}});k=function(a){this.page=1;this.querying=this.allLoaded=!1;this.search=a};e.extend(k.prototype,{ready:function(){return!(this.querying||
this.allLoaded)},ajax:function(a){var d=this,b={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:c.nonce.val()};this.search&&(b.search=this.search);this.querying=!0;e.post(ajaxurl,b,function(c){d.page++;d.querying=!1;d.allLoaded=!c;a(c,b)},"json")}});e(document).ready(function(a){a("#link-title-field").prev().text(wpLinkL10n.link_text)});e(document).ready(wpLink.init)})(jQuery);